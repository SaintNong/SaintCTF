{% extends "base.html" %}
{% block title %}Challenges{% endblock %}

{% block head %}
    {{ super() }}
    <!-- Sweet alert -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@5/dark.css"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <!-- as lazy as normal alerts, better than you could make them yourself -->

    <script>
        // OH MY GOD ITS JQUERY RUNNNNNN
        $(document).ready(function () {
            $('#flag-form').submit(function (e) {
                // Prevents default ugly form submission
                e.preventDefault();

                // Extract data
                let form = $(this);

                $.ajax({
                    type: 'POST',
                    url: '/submit-flag',
                    data: form.serialize(), // Pass the form data to the endpoint

                    // When the response comes back
                    success: function (response) {
                        console.log(response)

                        // If the flag was correct
                        if (response.status === 'correct') {
                            // Correct alert
                            Swal.fire({
                                title: "Correct flag!",
                                text: response.message,
                                icon: "success"

                            }).then(
                                function () {
                                    // Reload page after the user dismisses the alert
                                    // This is to update the solved challenges and user score
                                    window.location.reload()
                                }
                            );


                        } else if (response.status === 'already_submitted') {
                            // Already submitted alert
                            Swal.fire({
                                title: "Already submitted!",
                                text: response.message,
                                icon: "warning"
                            });

                        } else {
                            // Wrong alert
                            Swal.fire({
                                title: "Wrong flag!",
                                text: response.message,
                                icon: "error"
                            });
                        }

                    },

                    // After its all done, we clear the flag input field
                    complete: function (data) {
                        let input = $('#flag')
                        input.val('');
                    }
                });
            });
        });


        $(document).ready(function () {
            const filters = ['category', 'difficulty'];

            // Script for challenge filtering
            $('#filter-form').on("change", function (e) {
                // Values of the selected filters
                const selectedFilters = filters.map((f) => $(`[name="${f}"]`).val());
                const showSolved = $('[name="solved"]').prop('checked');

                let visibleCount = 0;
                $('.challenge').each(function () {
                    const challenge = $(this);

                    challenge.stop(true, false); // Clear queue of animations, but do not jump to end of current animation.

                    // Whether or not the selected filters matches the challenge card's attributes
                    const matchesFilters = filters.map((f, i, filters) => {
                        const sf = selectedFilters[i]; // selected filter
                        return sf === "" || challenge.data(f) === sf;
                    });
                    const matchesUnsolved = challenge.data('solved') === undefined;

                    const effectOptions = {duration: 250, easing: "linear"};

                    if (matchesFilters.every((x) => x) && (matchesUnsolved || showSolved)) {
                        // If a matched filter is not "All <filter type>", highlight it
                        //   i.e. only an explicitly selected filter should be highlighted
                        filters.forEach((f, i, filters) => {
                            const value = selectedFilters[i] !== "" ? true : null;
                            challenge.find(`.filter-tag[data-filter-type=${f}]`).attr('data-selected', value);
                        });

                        challenge.slideDown(effectOptions);
                        visibleCount++;
                    } else {
                        challenge.find(".filter-tag").attr('data-selected', null);
                        challenge.slideUp(effectOptions);
                    }
                });

                $("#visible-count").html(visibleCount);
            });

            // Setup filtering tags
            function setupFilteringTags(filterType) {
                $(`.filter-tag[data-filter-type=${filterType}]`).on('click', function (e) {
                    // https://stackoverflow.com/a/10086501 Why `currentTarget`?
                    const state = e.currentTarget.innerText;
                    const stateSelectField = $(`[name="${filterType}"]`)
                    if (stateSelectField.val() === state) {
                        stateSelectField.val('').trigger('change');
                    } else {
                        stateSelectField.val(state).trigger('change');
                    }
                });
            }

            filters.forEach((f) => setupFilteringTags(f));
        });

    </script>
{% endblock %}

{% block body %}
    <main id="challenge-main">
        {% set unsolved_count = challenges|length - solved_count %}

        <div id="flag-section-container">
            <section id="flag-section">
                <h1>Welcome {{ current_user.username }}!</h1>
                <p>You have {{ current_user.score }} points.</p>

                <h2>Filter Challenges</h2>
                <p><span id="visible-count">{{ unsolved_count }}</span> / {{ challenges|length }} challenge(s) visible</p>

                <!-- Challenge filtering form -->
                <form id="filter-form" action="javascript:void(0);">
                    <select name="category">
                        <option value="">All Categories</option>
                        <option value="web">web</option>
                        <option value="crypto">crypto</option>
                        <option value="pwn">pwn</option>
                        <option value="rev">rev</option>
                        <option value="osint">osint</option>
                        <option value="steg">steg</option>
                        <option value="misc">misc</option>
                    </select>
                    <select name="difficulty">
                        <option value="">All Difficulties</option>
                        <option value="free points">free points</option>
                        <option value="easy">easy</option>
                        <option value="medium">medium</option>
                        <option value="hard">hard</option>
                    </select>
                    <div>
                        <input type="checkbox" name="solved" id="solved" />
                        <label for="solved">Show solved challenges ({{ solved_count }})</label>
                    </div>
                </form>


                <h2>Flag Submission</h2>
                <!-- Flag submission form -->
                <form action="/submit-flag" id="flag-form" method="post">
                    <label for="flag"></label><input type="text" id="flag" name="flag" placeholder="saint{EXAMPLE_FLAG}">
                    <input type="submit" value="Submit Flag">

                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                </form>

            </section>
        </div>

        <section id="challenge-list">
            <p>{{ unsolved_count }} challenge(s) left to solve</p>

            {% for id, challenge in challenges.items() %}
                <article class="challenge" data-category="{{ challenge.category }}"
                         data-difficulty="{{ challenge.difficulty }}"
                         {% if solves[id]|map(attribute='user.username')|select('eq', current_user.username)|list %}
                             data-solved style="display: none;"
                         {% endif %}
                     >
                    <!-- Challenge info -->
                    <header>
                        <div>
                            <h2>{{ challenge.name }} </h2>
                            <p class="author">{{ challenge.author }}</p>
                        </div>

                        <div class="info-block">
                            <a class="filter-tag" href="javascript:void(0);" data-filter-type="difficulty" title="Filter by difficulty">{{ challenge.difficulty }}</a>
                            <a class="filter-tag" href="javascript:void(0);" data-filter-type="category" title="Filter by category">{{ challenge.category }}</a>
                            <p class="points">{{ challenge.points }} points</p>
                        </div>
                    </header>
                    <p class="description"> {{ challenge.description | safe }} </p>

                    {% if challenge.files %}
                        <!-- Challenge downloads -->
                        <div class="files">
                            <h3>Files</h3>
                            <ul>
                                {% for file in challenge.files %}
                                    <li><a href="downloads/{{ id }}/{{ file }}" download="{{ file }}">{{ file }}</a></li>

                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    {% if challenge.container %}
                        <!-- Challenge Links-->
                        <div class = "files">
                            <h3>Link</h3>
                            <ul>
                                <li><a href="{{ challenge.container.url }}">{{ challenge.container.url }}</a></li>
                            </ul>
                        </div>
                    {% endif %}
                  
                    <footer>
                        {% if solves[id] %}
                            <details class="solves-count">
                                <summary>{{ solves[id]|length }} solve(s)</summary>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Time</th>
                                        </tr>
                                    </thead>
                                    {% for solve in solves[id] %}
                                        <tr {% if solve.user.username == current_user.username %}
                                            class="highlight"
                                            {% endif %}
                                            >
                                            <td>{{solve.user.username}}</td>
                                            <td>{{solve.time | time_ago}}</td>
                                        </tr>
                                    {% endfor %}
                                </table>
                            </details>
                        {% else %}
                            <p class="solves-count">0 solves</p>
                        {% endif %}
                    </footer>


                </article>
            {% endfor %}
        </section>
    </main>
{% endblock %}
